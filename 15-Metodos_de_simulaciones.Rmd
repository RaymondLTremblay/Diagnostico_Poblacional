# Métodos de Simulaciones y estimaciones de intervalos de confianza


Por: Raymond L. Tremblay


```{r}
library(tidyverse)

library(ggtext)

library(janitor)

library(popbio)
```


El termino **biología** pudiese ser un sinónimo de variación biológica. No hay dos organismos iguales, ni siquiera gemelos idénticos. La variación biológica es una característica fundamental de la vida y es la base de la evolución. Cuando se considera los individuos, por ejemplos humanos, fácilmente reconocemos variación, en tamaño, color de ojos, suceptibilidad a cáncer o infección y efecto que tiene el ambiente (por ejemplo la dieta o acceso a la educación) entre muchos que impacto la supervivencia o crecimiento y reproducción. Pero desafortunadamente cuando se considera los animales y plantas de una misma especie frecuentemente se obvia la variación en los análisis.  Podemos observar variación a múltiples niveles en una misma especie

- Variación sub-individual
- Variación entre individuos
- Variación entre poblaciones
- Variación entre tiempo

Tambien en este capitulo la variación por tamaño de muestra pequeña sobre los parámetros.


### Componentes de Variación 

#### La variación sub-individual

La variación sub-individual es la variación que se observa en un individuo. Por ejemplo, la variación en el tamaño o la cantidad de hojas, flores, frutos, semillas dentro del mismo individuo. Este tipo de variación es común en plantas y animales y es un componente importante de la variación total pero raramente se considera en los análisis. Carlos Herrera ha demostrado claramente que este componente no solamente es parte de la variación total de las especies pero es importante para entender los procesos ecológicos y evolutivos [@herrera2009multiplicity]. Esta variación al conocimiento de los autores nunca ha sido incluido en análisis de dinámica poblacional y integrado dentro un PPM. 

#### La variación entre individuos

La variación entre individuos es la diferencias que se observa entre individuos de una misma población. Por ejemplo, la variación en el tamaño de los individuos, tamaño de las hojas, cantidad de flores, cantidad de frutos entre individuos de una misma población influye en la probabilidad de sobrevivir, crecer y reproducirse. La variación entre individuos impacta grandemente la supervivencia y reproducción de los individuos. Los trabajos de Harper y otros han demostrado que esa variación es común en las plantas [@harper1977population].

#### La variación entre poblaciones

La variación entre poblaciones es la variación que se observa entre poblaciones de una misma especie. Poblaciones distintas pudiese ser influenciada por la diferencias abióticas y interacciones biótica única a cada población.  Esa variación pudiese influenciar la dinámica de cada población y la dinámica de la especie en general. 

#### La variación entre tiempo

Este componente de variación incluye la variación típicamente relacionado a la variación abiótica que cambia de un periodo de tiempo a otro. Pero no se debería limitar a considerar solamente la variación abiótica en tiempo ya que la variación biótica también puede cambiar de un periodo de tiempo a otro. Por ejemplo la densidad y/o composición de especies en una comunidad cambia de un periodo de tiempo alrededor de la especie de interés y pudiese influenciar la dinámica estimado por la parámetros de la matriz. Otro ejemplo considera la variación en presencia de herbívoros o patógenos que cambia de un periodo de tiempo a otro y pudiese influenciar la dinámica de la especie de interés. 

### Variación en tamaño de muestra pequeña

En la gran mayoría de los estudios usando MPP son para evaluar la probabilidad de supervivencia en una especies en peligro de extinción (Do we have the data in COMPADRE to answer this?). La razón principal es que típicamente porque queda muy pocos individuos en la población o pocas poblaciones resulta en tamaño de muestra pequeñas. Como ejemplo consideré que tenemos una especies donde se evalúa los pocos individuos en una población para monitorear en cada etapas de la vida (puediese incluir hasta todos los individuos todavia vivos de esta especie). 

Por ejemplo si tuviésemos en esta población solamente un adulto y este adulto sobrevive a la etapa de adulto a adulto entonces la probabilidad de supervivencia es 1.0. Pero si tuviésemos solamente un adulto y este adulto muere entonces la probabilidad de supervivencia es 0.0. En ambos casos la probabilidad de supervivencia es 1.0 o 0.0 respectivamente. Pero tuviésemos 1,000 o 10,000 individuos es muy poco probable que todos se mueren o todos sobreviven. Este es un ejemplo extremo pero ilustra claramente el problema de estimar la probabilidad de supervivencia en una población con un tamaño de muestra puede resultar en estimados sesgados por resultado de tamaño de muestra.  

En las próximas secciones vamos a explorar los métodos de simulaciones y estimaciones de intervalos de confianza para abordar la variación biológica y la variación en tamaño de muestra pequeña.  

## Introducciones a métodos de simulaciones para estimados de variación

### Estocasticidad variación entre individuos




### Estocasticidad espacial

En este caso vemos el efecto de la variación espacial en la probabilidad en los estimados. 


#### Entrada de datos

El primer paso es definir la diferentes matriz, una por cada periodo de tiempo. En el siguiente script se enseña como entrar los datos para múltiples matrices en un solo objeto. Nota que es una lista de matriz. 
Los datos provienen de un estudio de la dinámica de una población de *Serapia cordigera* de 1999 al 2012 evaluando el impacto antropogénico sobre la dinámica de la población.  En este caso se emplea solamente 6 matrices de transición de la población de *Serapia cordigera* en 1999, tres de estas son poblaciones que tienen impacto antropogénico (A1, A2 y A3) y tres poblaciones naturales, sin impacto antropogénico (N1, N2, N3).


```{r}


Serapia<-list(
  A1_1999=matrix(c(
0.745,	0.152,	0.452,	0.564,
0.125,	0.000,	0.000,	0.000,
0.000,	0.321,	0.205,	0.342,
0.200,	0.365,	0.205,	0.185
  ),
  nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
A2_1999=matrix(c(
0.648,	0.203,	0.414,	0.604,
0.188,	0.000,	0.000,	0.000,
0.000,	0.342,	0.198,	0.377,
0.242,	0.264,	0.225,	0.191
),
 nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
A3_1999=matrix(c(
0.544,	0.223,	0.364,	0.498,
0.148,	0.000,	0.000,	0.000,
0.000,	0.249,	0.243,	0.287,
0.242,	0.303,	0.210,	0.101
),
nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
N1_1999=matrix(c(
0.287,	0.271,	0.054,	0.107,
0.318,	0.000,	0.000,	0.000,
0.000,	0.438,	0.228,	0.273,
0.111,	0.512,	0.585,	0.542
),
nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
N2_1999=matrix(c(
0.299,	0.253,	0.066,	0.182,
0.324,	0.000,	0.000,	0.000,
0.000,	0.461,	0.222,	0.264,
0.339,	0.568,	0.554,	0.547
),
nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
N3_1999=matrix(c(
  0.245,	0.156,	0.052,	0.147,
0.325,	0.000,	0.000,	0.000,
0.000,	0.422,	0.305,	0.252,
0.210,	0.465,	0.498,	0.485
),
nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  )
)



Serapia

```


#### Simulaciones con igual probabilidad de selección

Si uno asume que hay igual cantidad de poblaciones afectada de forma antropogénicas y naturales entonces se puede hacer un análisis de la variación espacial en la probabilidad de supervivencia. Se puede simular el crecimiento con igual probabilidad de selección de las matrices de transición. en otra palabra cada matriz sera seleccionado al azar 1/6 de las veces. Este supuesto es razonable si uno asume que hay igual cantidad de poblaciones afectada de forma antropogénicas y naturales. El objetivo es ver la variación en la probabilidad de supervivencia en la población de *Serapia cordigera* en 1999 o mejor cual seria el tamaño de la poblacional típica de la especies si la especie se comporta como la siguientes matrices [@pellegrino2014effects].

La función `stoch.projection` del paquete `popbio` permite hacer simulaciones de la dinámica de una población y da una lista de la cantidad de individuos esperado por cada etapa de la vida. Comenzamos por definir el tamaño de la población inicial por etapa de la vida, **n**, el nombre de las etapas de la vida y luego usamos la función `stoch.projection` para hacer las simulaciones.



```{r}

n <- c(2, 0, 4, 99) # corresponde a los datos de la especies en la publicación del año 2000
names(n) <- c("latente", "plantula", "rosetta", "con flor")
Serapia.eq   <- stoch.projection(Serapia, n, nreps=1000) # simulación con igual probabilidad de selección

head(Serapia.eq) # vemos las primeras 6 simulaciones de tamaño de muestra


```


### Cual es la distribución de numero de individuos esperado.

para observar cuantos individuos hubiese en el futuro de la población de *Serapia cordigera* en 1999 si la especie se comporta como las matrices de transición.



```{r}
Serapia.eq=clean_names(as.data.frame(Serapia.eq))

Serapia.eq %>% 
  gather(key="etapa", value="individuos") %>% 
  ggplot(aes(x=individuos))+
  geom_histogram(bins=30, fill="blue", color="black")+
  facet_wrap(~etapa, scales="free")+
  theme_minimal()+
  labs(title="Distribución de número de individuos esperado de *Serapia cordigera*",
       x="Número de individuos", y="Frecuencia")+
  theme(title = element_markdown())
```


```{r}
Serapia_eq_T=Serapia.eq %>% 
  mutate(total=rowSums(across(where(is.numeric)))) 

  
  ggplot(Serapia_eq_T,aes(x=total))+
  geom_histogram(bins=30, fill="blue", color="black")+
  theme_minimal()+
  labs(title="Distribución de total de individuos esperado de *Serapia cordigera*",
       x="Número Total de individuos por simulación", y="Frecuencia")+
  theme(title = element_markdown())
```


### Simulaciones con diferente probabilidad de selección

La probabilidad de selección de las matrices de transición no tiene que ser igual. En el siguiente script se muestra como hacer simulaciones con diferente probabilidad de selección de las matrices de transición. En este caso se asume que hay las 3 poblaciones afectada de forma antropogénicas son más comun en la especies y las 3 poblaciones naturales son poblaciones raras.  En la sección del script vemos que ahora las poblaciones afectada de forma antropogénicas son seleccionadas con una probabilidad de 0.85 y las poblaciones naturales con una probabilidad de 0.15. En otra palabra las poblaciones naturales son muy raras, y la especies es ta dominada por sitio donde la especies es afectada de forma antropogénicas. **Importante este es una simulación y no refleja la realidad de la especies ni la publicación**.




```{r}

n <- c(2, 0, 4, 99) # población inicial por etapa
names(n) <- c("latente", "plantula", "rosetta", "con flor")
Serapia.uneq   <- stoch.projection(Serapia, n, nreps=1000, prob=c(.3, .3, .25, .05, .05, .05)) # simulación con igual probabilidad de selección

head(Serapia.uneq) # vemos las primeras 6 simulaciones de tamaño de muestra


```

### Comparar la distribución de cantidad de individuos esperado por simulaciones

Ahora vamos a solapar las dos distribuciones para ver si hay una diferencia en la distribución de tamaño de muestra entre las dos simulaciones. Los resultados de la simulaciones siguiere que las poblaciones afectada de forma antropogénicas (rojo) tienen una mayor cantidad de individuos en el futuro que las poblaciones naturales (azul). 


```{r}
Serapia.uneq=clean_names(as.data.frame(Serapia.uneq))

Serapia.uneq_T=Serapia.uneq %>% 
  mutate(total=rowSums(across(where(is.numeric)))) 


ggplot(Serapia.uneq_T, aes(total))+
  geom_histogram( bins=30, fill="red", color="black", alpha=.5)+
  geom_histogram(data=Serapia_eq_T, aes(x=total), bins=30, fill="blue", color="black", alpha=.5)+
  theme_minimal()+
  labs(title="Distribución de total de individuos esperado de *Serapia cordigera*",
       x="Número Total de individuos por simulación", y="Frecuencia")+
  theme(title = element_markdown())

```


***


#### Simlación de crecimiento poblaciónal de *Serapia cordigera*


En el siguiente script podemos evaluar el crecimiento poblacional y su variación en el espacio.

Nota aquí se calcula el log(crecimiento poblacional estocástica) de la especies de *Serapia cordigera* por aproximación y simulaciones siguiente la formula de Tuljapukar [@tuljapurkar2013population]. Se puede ver que la especies tiene un crecimiento poblacional negativo en la mayoría de las simulaciones. Esto sugiere que la especies esta en declive. Pero también se puede ver que hay una variación en el crecimiento poblacional de la especies. El script incluye un parámetro para indicar por cuanto tiempo queremos que la simulación ocurre, **maxt=**, en esta caso se simula por 50 periodos de tiempo, si no se añade nada la simulación dura por 50000 periodos de tiempo. 

Cuando se usa el log de crecimiento poblacional estocástica se calcula  $$r$$, ese valor es $r=ln(\lambda)$. $r$ se interpretación de forma diferentes que los valores de lambda,

- $r$ = log(crecimiento poblacional estocástica) > 0 la población crece
- $r$ = log(crecimiento poblacional estocástica) < 0 la población decrece
- $r$ = log(crecimiento poblacional estocástica) = 0 la población no cambia

El crecimiento estocástico de las poblaciones de *Serapia cordigera* en 1999 es negativo, sugiere que la especies esta en declive. Pero también se puede ver que hay una variación en el crecimiento poblacional de la especies. Se usa la función *stoch.grwoth.rate*

```{r}
SGR_eq=stoch.growth.rate(Serapia, maxt=50, verbose=) # matrices seleccionado con igual probabilidad
SGR_eq

SGR_uneq=stoch.growth.rate(Serapia, maxt=50, prob=c(.3, .3, .25, .05, .05, .05), verbose=FALSE) # matrices seleccionado con diferente probabilidades

SGR_uneq

```


Nota que los intervalos de confianza del crecimiento estocástico no solapa el zero para simulaciones con igual probabilidades, pero con probabilidades diferentes solapa el zero. Por consecuencia hay evidencia que en este caso, que las poblaciones si se comportará con igual frecuencia son afectada de forma antropogénicas o naturales, y la especies esta en declive. Al contrario, si la mayoría de las poblaciones son afectada de forma antropogénicas, la especies no esta en declive. 


Para convertir el log(crecimiento poblacional estocástica) a lambda se usa la siguiente formula $e^r$

#### Conversión de $r$ a $\lambda$

 Lambda Igual de probabilidades
```{r}


exp(SGR_eq$sim) # matrices seleccionado con igual probabilidad
exp(SGR_eq$sim.CI[1]) #El intervalo de confianza inferior
exp(SGR_eq$sim.CI[2]) #El intervalo de confianza superior
```


Lambda Diferente de probabilidades

```{r}
exp(SGR_uneq$sim) # matrices seleccionado con diferente probabilidades
exp(SGR_uneq$sim.CI[1]) #El intervalo de confianza inferior 
exp(SGR_uneq$sim.CI[2]) #El intervalo de confianza superior
```



```{r}
library(popbio)

# El primer paso es definir la diferentes matriz, una por cada periodo de tiempo



n <- c(4264, 3,30,16,25,5)
names(n) <- c("seed",  "seedlings", "tiny", "small", "medium" , "large")
## use equal and unequal probabilities for matrix selection
x.eq   <- stoch.projection(hudsonia, n, nreps=1000)
x.uneq <- stoch.projection(hudsonia, n, nreps=1000, prob=c(.2,.2,.2,.4))
hist(apply(x.eq, 1, sum), xlim=c(0,5000), ylim=c(0,200), col="green",
breaks=seq(0,5000, 100), xlab="Final population size at t=50", main='')
par(new=TRUE)
## use transparency for overlapping distributions - may not work on all systems
hist(apply(x.uneq, 1, sum), xlim=c(0,5000), ylim=c(0,200), col=rgb(0, 0, 1, 0.2),
 xaxt='n', yaxt='n', ylab='', xlab='', breaks=seq(0,10000, 100), main='')
legend(2500,200,  c("equal", "unequal"),fill=c("green", rgb(0, 0, 1, 0.2)))
title(paste("Projection of stochastic growth for Hudsonia
using equal and unequal probabilities"), cex.main=1)
## initial pop size
sum(n)
abline(v=sum(n), lty=3)
```

***



### Estocasticidad temporal


El objetivo de evaluar la variación en tiempo es para determinar si los cambios temporales son importante en predecir el cambio poblacional.  

Seguimos con los datos *Serapias cordigera*, pero ahora evaluar cual es el efecto de la variación en los parámetros de la matriz usando múltiple censos. Vemos el efecto de una esas población, por impacto antropogenico, **A1** en los años de 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011 y 2012. 

El primer paso en entrar los datos en una lista de matrices de transición. 

```{r}
Serapia_tiempo<-list(
  A1_1999=matrix(c(
0.745,	0.152,	0.452,	0.564,
0.125,	0.000,	0.000,	0.000,
0.000,	0.321,	0.205,	0.342,
0.200,	0.365,	0.205,	0.185
  ),
  nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
A1_2000=matrix(c(
0.578,	0.222,	0.394,	0.394,
0.188	,0.000,	0.000,	0.000,
0.000	,0.322,	0.254,	0.357,
0.244	,0.314,	0.125,	0.302
  ),
  nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
A1_2001=matrix(c(
  0.668,	0.122,	0.294,	0.401,
0.128,	0.000	,0.000,	0.000,
0.000,	0.302	,0.453,	0.366,
0.214,	0.364,	0.185,	0.207
  ),
  nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
A1_2002=matrix(c(
0.645,	0.222,	0.682,	0.504,
0.177,	0.000,	0.000,	0.000,
0.000,	0.421,	0.305,	0.382,
0.102,	0.355,	0.208,	0.208
  ),
  nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
A1_2003=matrix(c(
  0.545,	0.113,	0.424,	0.424,
0.247,	0.000,	0.000,	0.000,
0.000,	0.166,	0.233,	0.277,
0.192,	0.253,	0.209,	0.212

  ),
  nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
A1_2004=matrix(c(
  0.548,	0.191,	0.402,	0.527,
0.327,	0.000,	0.000,	0.000,
0.000,	0.338,	0.127,	0.394,
0.211,	0.262,	0.296,	0.142
  ),
  nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
A1_2005=matrix(c(
  0.602,	0.153,	0.486,	0.562,
0.224,	0.000,	0.000,	0.000,
0.000,	0.491,	0.324,	0.304,
0.139,	0.268,	0.294,	0.277

  ),
  nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
A1_2006=matrix(c(
  0.487,	0.471,	0.425,	0.607,
0.318,	0.000,	0.000,	0.000,
0.000,	0.438,	0.328,	0.373,
0.211,	0.212,	0.285,	0.142
  ),
  nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
A1_2007=matrix(c(
  0.544,	0.423,	0.374,	0.578,
0.348,	0.000,	0.000,	0.000,
0.000,	0.441,	0.248,	0.288,
0.145,	0.203,	0.311,	0.201

  ),
  nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
A1_2008=matrix(c(
 0.568,	0.325,	0.294,	0.607,
0.227,	0.000,	0.000,	0.000,
0.000,	0.402,	0.553,	0.256,
0.194,	0.364,	0.275,	0.217

  ),
  nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
A1_2009=matrix(c(
  0.545,	0.356,	0.472,	0.398,
0.225,	0.000,	0.000,	0.000,
0.000,	0.322,	0.304,	0.452,
0.110,	0.225,	0.298,	0.185

  ),
  nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
A1_2010=matrix(c(
  0.399,	0.352,	0.486,	0.580,
0.424,	0.000,	0.000,	0.000,
0.000,	0.561,	0.312,	0.264,
0.239,	0.168,	0.354,	0.247

  ),
  nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  ),
A1_2011=matrix(c(
  0.497,	0.352,	0.465,	0.622,
0.324,	0.000,	0.000,	0.000,
0.000,	0.361,	0.321,	0.264,
0.139,	0.368,	0.367,	0.177

  ),
  nrow=4, byrow=TRUE,
  dimnames=list(c("latente", "plantula", "rosetta", "con flor"),
                c("latente", "plantula", "rosetta", "con flor")
  )
  )
)


 Serapia_tiempo
 
  
  
  
```

#### Simulaciones con igual probabilidad de selección

```{r}
n <- c(2, 0, 4, 99) # población inicial por etapa
names(n) <- c("latente", "plantula", "rosetta", "con flor")
Serapia_tiempo_eq   <- stoch.projection(Serapia_tiempo, n, nreps=1000) # simulación con igual probabilidad de selección

head(Serapia_tiempo_eq) # vemos las primeras 6 simulaciones de tamaño de muestra

```

```{r}

SGR_Temp_eq=stoch.growth.rate(Serapia_tiempo, maxt=50) # matrices seleccionado con igual probabilidad
SGR_Temp_eq



exp(SGR_Temp_eq$sim) # matrices seleccionado con igual probabilidad
exp(SGR_Temp_eq$sim.CI[1]) #El intervalo de confianza inferior
exp(SGR_Temp_eq$sim.CI[2]) #El intervalo de confianza superior
```

Comparar la variación temporal en el crecimiento poblacional de la especies de *Serapia cordigera* en 1999 a 2012 con la variación espacial.

Lo que se observa es que la variación temporal y la variación espacial es más o menos igual (el rango de variación), pero que hay menos variación temporal que espacial. 



```{r}
Tabla_resultado=tribble(
  ~tipo, ~valor, ~CI_inf, ~CI_sup,~diff_ci,
  "Espacial", exp(SGR_eq$sim), exp(SGR_eq$sim.CI[1]), exp(SGR_eq$sim.CI[2]), exp(SGR_eq$sim.CI[2])-exp(SGR_eq$sim.CI[1]),
  "Temporal", exp(SGR_Temp_eq$sim), exp(SGR_Temp_eq$sim.CI[1]), exp(SGR_Temp_eq$sim.CI[2]), exp(SGR_Temp_eq$sim.CI[2])-exp(SGR_Temp_eq$sim.CI[1])
) 
Tabla_resultado
```


Observación de la variación temporal y espacial en el crecimiento poblacional de la especies de *Serapia cordigera* en un gráfico. 

Se nota que el crecimiento poblacional intrínsico de la especies de *Serapia cordigera* es negativo en la mayoría de las simulaciones cuando se evalúa múltiple poblaciones, pero la población **A1** en general tiene un crecimiento positivo o es estable cuando se evalúa tomando en cuanta la variación temporal .



```{r}


 
  ggplot(Tabla_resultado, aes(x=tipo, y=valor))+
  geom_point(stat="identity", fill="blue")+
  geom_errorbar(aes(ymin=CI_inf, ymax=CI_sup), width=.2)+
  theme_minimal()+
  labs(title="Comparación de crecimiento poblacional de *Serapia cordigera*",
       x="Tipo de variación", y="Crecimiento poblacional")+
  theme(title = element_markdown())
```



### Estocasticidad demografica



En esta sección vemos el efecto del tamaño de muestra sobre los parámetros de la matriz de transición.

Este método usa un acercamiento Bayesiano y una distribución de probabilidad para estimar los parámetros de la matriz de transición Dirichlet de múltiples grupos discretos. Vemos a que se refiere un análisis Bayesiano y la función Dirichlet. El lo que corresponde al presenta análisis Bayesiano, incluimos una previa al análisis, en otra palabra, se usa información previa para incluirlos en los calular para estimar los parámetros (posteriores).  En nuestro caso haremos una previa con poco peso, en otra palabra, no influirá mucho (o casi nada) en los resultados.

La función Dirichlet es una expansión de una función bien básica de probabilidad, usando una distribución beta. La función beta es una distribución de probabilidad continua en el intervalo (0,1) y se usa para modelar la probabilidad de un evento binario. La función Dirichlet es una generalización de la función beta y se usa para modelar la probabilidad de un evento multinomial. 

Comenzamos con lo más básico, probabilidades de dos grupos. Consideramos un grupo de 10 individuos, si 6 de estos individuos sobreviven, cual es la proporción que no sobreviven. La probabilidad de sobrevivir es $p=6/10$, entonces la probabilidad de no sobre vivir $\hat{p}=1-p$, porque siempre la suma de $p + \hat{p}= 1$.  probabilidad de que un individuo sea de un grupo es 0.5. 

Ahora si tenemos tres grupos, digamos, plántulas que se quedan como plántula, que crecen a juveniles o que mueren. En este caso tenemos tres grupos (multinomial) y la probabilidad de que un individuo de las proporciones tiene que sumar a 1. 

La otra ventaja de usar la función Dirichlet es que se basa en la distribución beta. Este una distribución donde tanto los parámetros como el promedio, y los intervalo de confianza son limitado a 0 y 1. Otra manera de decir lo mismo que que no se puede tener intervalos de confianza menos 0 o mayor de 1.  Hagan el ejercicio mental de tratar de entender un intervalo de confianza de -0.10. Si una usa una distribución normal, los intervalos de confianza pueden ser negativos o mayores de 1, lo que no tiene sentido en el contexto de probabilidad.

En el siguiente script se muestra como hacer un análisis Bayesiano de la matriz de transición de *Serapia cordigera* en 1999. Seleccionamos la población **A1** en 1999. 

```{r}
library(popbio)
n <- c(2, 0, 4, 99) # población inicial por etapa
names(n) <- c("latente", "plantula", "rosetta", "con flor")
Serapia_A3   <- splitA(Serapia$A3) # simulación solamente la matriz A1 de la lista de matriz


```

En el siguiente paso vamos a asignar una previa a los datos. Estas previas proviene de Tremblay, no representa la visión de los autores del articulo. Se añade una previa también para la proporción de plantas que fallece en cada etapa (la quita fila) Nota que es importante que la suma de cada columna sea igual a 1. 

```{r}
RLT_Serapia_previa <- matrix(c(0.5, 0.1,   0.4,   0.4,
                        0.2,  0.,    0.0,   0.0,
                        0.0,  0.025, 0.25,  0.3,
                        0.15,  0.05,  0.25,  0.2,
                        0.05,  0.025, 0.1,   0.1), 
                     byrow = TRUE, nrow = 5, ncol = 4)
```


```{r}
library(raretrans)

```


### Obtener los inertvalos de confianza (IC) para entradas de matriz individuales

La distribución posterior marginal de un elemento en un multinomio es una
distribución beta, y usamos esto para obtener intervalos creíbles en nuestro
tasas de transición. Podemos usar el tipo de retorno TN para obtener los parámetros de el multinomio deseado.

Nota que: 

 -TF tiene que ser una matriz divido entre la transición y de fecundidad (matT + matF),
 - N es el tamaño de muestra de cada etapa de la vida,
 - P es la previa de la matriz de transición,
 - priorweight es el peso de la previo (en este caso estamod dando muy poca importancia a la previa, como si fuese una décima de un individuo), lo que resulta en que los datos del campo domina el análisis.
 - Regresa el análisis posterior de la matriz de transición.
 
En el script vemos los intervalos de confianza de la matriz de transición de *Serapia cordigera* en 1999 para la población A3. 

Lo más dramático de ese primer análisis que que los intervalos de credibilidad son bien grandes, casi todos los intervalos de credibilidad **lcl** y **ucl** an de muy cerca de cero a valores muy grande. Esto sugiere que hay mucha incertidumbre en los datos. Este resultado es esperado, porque la muestra es muy pequeña, solamente 2 individuos fueron muestreado en el campo de esta etapa. 




```{r }
TN <- fill_transitions(Serapia_A3, N=n, P = RLT_Serapia_previa, priorweight = .01, returnType = "TN")
a <- TN[,1] # cambie 1 a 2, 3 etc para obter la distribución beta marginal de cada columna. 
b <- sum(TN[,1]) - TN[,1]# cambie 1 a 2, 3 etc para obter la distribución beta marginal de cada columna. 
p <- a / (a + b)
lcl <- qbeta(0.025, a, b)
ucl <- qbeta(0.975, a, b)
A3=knitr::kable(sprintf("%.3f, %.3f, %.3f", p, lcl, ucl))

A3df_lat=round(data.frame(p, lcl, ucl), digits=3)
A3df_lat

```


Ahora vemos que pasa con la etapa que tenemos más datos, los adultos con flores. En este caso vemos que los intervalos de credibilidad son más pequeños, pero todavía son grandes, ya que el tamaño de muestra es de 99 para esta etapa. 



```{r }
TN <- fill_transitions(Serapia_A3, N=n, P = RLT_Serapia_previa, priorweight = 0.01, returnType = "TN")
a <- TN[,4] # cambie 1 a 2, 3 etc para obter la distribución beta marginal de cada columna. 
b <- sum(TN[,4]) - TN[,4]# cambie 1 a 2, 3 etc para obter la distribución beta marginal de cada columna. 
p <- a / (a + b)
lcl <- qbeta(0.025, a, b)
ucl <- qbeta(0.975, a, b)
 A3=knitr::kable(sprintf("%.3f, %.3f, %.3f", p, lcl, ucl))

A3df=round(data.frame(p, lcl, ucl), digits=3)

A3df
```


Como ejercicio, vemos que tipo de intervalos si tuviesemos tamaño de muestra de 500 individuos en la etapa de adulto. Nota que aun que los intervalos de credibilidad son más pequeños, no se debería asumir que no hay variación demográfica en la etapa de adulto, por procesos estocasticos.


```{r }

n500 <- c(2, 0, 4, 500) # población inicial por etapa
TN <- fill_transitions(Serapia_A3, N=n500, P = RLT_Serapia_previa, priorweight = 0.01, returnType = "TN")
a500 <- TN[,4] # cambie 1 a 2, 3 o 4 ect. para obtener la distribución beta marginal de cada columna (etapas). 
b500 <- sum(TN[,4]) - TN[,4]# cambie 1 a 2, 3 ect. para obtener la distribución beta marginal de cada columna. 
p500 <- a500 / (a500 + b500)
lcl <- qbeta(0.025, a500, b500)
ucl <- qbeta(0.975, a500, b500)
 A3=knitr::kable(sprintf("%.3f, %.3f, %.3f", p, lcl, ucl))

A3df=round(data.frame(p, lcl, ucl), digits=3)

A3df
```


Ahora vemos como se distribuye una distribución beta. 

Usamos los datos de la etapa de adulto con flores con 99 individuos. Ninguna de la transiciones o estasis tiene una distribución normal.  La distribución que demuestra bien este patrón son los adultos con flores que pasan a latente. La linea reja vertical representa el promedio, o sea el valor en la matriz de transición. 



```{r, warning=FALSE}

a # los valores del shape alpha 
b # los valores del shape beta

# Función para visualizar la distribution beta
plot_beta <- function(alpha, beta) {
  x <- seq(0, 1, length.out = 100)
  y <- dbeta(x, alpha, beta)
  data <- data.frame(x = x, y = y)
  ggplot(data, aes(x, y)) +
    geom_line()
}

# Distirbuciones beta
Latentes=plot_beta(0.396, 99.594)+
  xlim(0, .1)+
    labs(title = paste("Distribución de latentes \n (alpha =", 0.396, ", beta =", 99.594, ")"),
         x = "Probabilidad", y = "Densidad")+
    theme(text = element_text(size = 6))+
  geom_vline(xintercept = 0.004, linetype = "dashed", color = "red")

Plantulas=plot_beta(0.000, 99.990)+
  xlim(0, .025)+ylim(0, .05)+
    labs(title = paste("Distribución de plántulas \n (alpha =", 0.000, ", beta =", 99.90, ")"),
         x = "probabilidad", y = "Densidad")+
    theme(text = element_text(size = 6))+
  geom_vline(xintercept = 0.000, linetype = "dashed", color = "red")

Rosetta=plot_beta(28.710, 71.280)+
  xlim(0, .5)+
    labs(title = paste("Distribución de rosettas \n (alpha =", 28.710, ", beta =", 71.280, ")"),
         x = "probabilidad", y = "Densidad")+
    theme(text = element_text(size = 6))+
  geom_vline(xintercept = 0.287, linetype = "dashed", color = "red")

Adultos=plot_beta(10.197, 89.793)+
  xlim(0, .27)+
    labs(title = paste("Distribución de Ind. con flores \n (alpha =", 10.197, ", beta =", 89.793, ")"),
         x = "probabilidad", y = "Densidad")+
    theme(text = element_text(size = 6))+
  geom_vline(xintercept = 0.102, linetype = "dashed", color = "red")

Fallecidos=plot_beta(60.687, 39.303)+
  xlim(.40, .8)+
    labs(title = paste("Distribución de fallecidos \n (alpha =", 60.687, ", beta =", 39.303, ")"),
         x = "probabilidad", y = "Densidad")+
    theme(text = element_text(size = 6))+
  geom_vline(xintercept = 0.607, linetype = "dashed", color = "red")



library(ggpubr)
ggarrange(Latentes, Plantulas, Rosetta, Adultos, Fallecidos, ncol=3, nrow=2)
```



***

## Ventaja de usar simulaciones

La primera ventaja de usar métodos de análisis por simulaciones es que se puede calcula intervalos de confianza. Si los intervalos de confianza de lambda solapa el uno (1) (si solapa el 0 para log(lambda)) entonces no hay evidencia de que el crecimiento poblacional es diferente de estable.

La segunda ventaja de usar simulaciones es que hay que recordar que los análisis están basado en datos limitados y que si hubiese más o menos datos para estimar los elementos de la matriz la parámetros de la matriz pudiese ser diferentes. Entonces hay un componente de incertidumbre en los estimados de los parámetros de la matriz, los valores de promedio no recolectan esa variación entre individuos, tiempo y espacio. 

La incertidumbre por causas intrínsicas (el individuos, genética, tamaño de muestra) y extrínsicas (hábitat, tiempo, variación en polinizadores, herbívoros, ect.) se evalúa usando análisis de variación espacial, temporal y demográficos. La incertidumbre en los parámetros de la matriz de transición se puede cuantificar con intervalos de confianza o el intervalo de credibilidad (concepto Bayesiano). Es de suma importancia que se evalué la incertidumbre en los parámetros de la matriz de transición para tener un mejor entendimiento de la variación en el crecimiento poblacional de una especies y saber si hay suficiente evidencia que la especies esta en declive, crece o no.








