# Compadre_Orchid PPM y su uso

## Raymond y Roberto

```{r chap16_1}
library(Rcompadre) # Paquete para trabajar con la base de datos de COMPADRE y COMADRE
library(tidyverse)
library(gt)
library(kableExtra)
```

```{r chap16_2, echo=FALSE}
library(tidyverse)

rlt_theme <- theme(axis.title.y = element_text(colour="grey20",size=15,face="bold"),
        axis.text.x = element_text(colour="grey20",size=10, face="bold"),
        axis.text.y = element_text(colour="grey20",size=15,face="bold"),  
        axis.title.x = element_text(colour="grey20",size=15,face="bold"))+
  theme(
  # Remove panel border
  panel.border = element_blank(),  
  # Remove panel grid lines
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  # Remove panel background
  panel.background = element_blank(),
  # add thicker border lines
    axis.line.x = element_line(colour = "black", linewidth  = 1),
    axis.line.y = element_line(colour = "black", linewidth  = 1)
  )

# The palette with grey:
cbPalette1 <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# The palette with black:
cbPalette2 <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# To use for fills, add
#  scale_fill_manual(values=cbPalette)

# To use for line and point colors, add
  #scale_colour_manual(values=cbPalette)

```

Este capítulo es una introducción a COMPADRE y algunas de la funciones en los paquetes de **Rcompadre** y **Rage**. La información aqui no sustituye la información proviste \<<https://compadre-db.org/>\> y los tutoriales que se encuentran en la siguiente pagina \<<https://compadre-db.org/Education>\>

## Acceso a los datos de COMPADRE.

Hay dos métodos de tener acceso a los datos de COMPADRE (datos de dinamica poblacional de plantas) y COMADRE (datos de dinamica poblacional de animales). Los datos se pueden acesar directamente en la pagina de web o bajar el archivo de datos al siguiente enlace \<<https://compadre-db.org/Data/Compadre>\> seleccionando la pestaña de **Download COMPADRE**.

## Para tener aceso a los datos cuando no esta conectado al internet es necesario bajar el archivo y instalar en su proyecto de RStudio.

```{r chap16_3}
compadre <- cdb_fetch("compadre")
#load("~/Library/CloudStorage/Dropbox/GitHub_Dropbox_Drive/GitHub/Diagnostico_Poblacional/Diagnostico_Poblacional/COMPADRE_v.6.23.5.0.RData")

#load("~/Dropbox/GitHub_Dropbox_Drive/GitHub/Diagnostico_Poblacional/Diagnostico_Poblacional/COMPADRE_v.6.23.5.0.RData") # work computer
```

##### Renombrar la base datos algo más sencillo

```{r chap16_4}
#ALLSp=as_cdb(compadre)  # Un paso critico: Convertir la base de datos anterior COM(P)ADRE (de clase 'list') en la base en un objeto CompadreDB (COMPADRE Database)

ALLSp=compadre
names(ALLSp) # La lista de los nombres de las variables en el archivo COMPADRE

```


#### Evaluate if new species are present in the data base

```{r chap16_5}
Ex = ALLSp %>% 
  filter(Genus %in% c("Epidendrum"))
Ex # This shows that the species added Epidendrum xanthinum is not yet included in the data base
```


#### Extraer (filter) solamente las especies de la familia **Orchidaceae** 

```{r chap16_6}
index_O=ALLSp %>% 
 filter(Family %in% c("Orchidaceae")) # Extraer la orquídeas de la base de datos. 


index_O

sort(unique(index_O$Genus))
```

### Lista de especies unicas de orquídeas en la base de datos de COMPADRE.

Note que al momento hay 46 especies con nombres unicos en la base de datos

```{r chap16_7}
sort(unique(index_O$SpeciesAccepted))


```

La base de datos de orquidea tiene un total de 647 filas, por consecuencia tiene 647 matrices.  Esas matrices de la misma especie son de diferentes poblaciones, tiempo o un analisis teóricos. 

```{r chap16_8}
index_O

```

Para saber de cuantos manuscritos distinctos probvienen esos datos uno puede evaluar la cantidad de DOI_ISBN distinctos. En este caso los de esas 647 matrices provienen de 34 fuentes de información publicada, revisada por pares, tesis o informes tecnicos. 

```{r chap16_9}
unique(index_O$DOI_ISBN)
```

Igualmente podemos evaluar cuantos distintos autores son responsable de esas publicaciones. Un total de 37 autores unicos o en grupo son la fuente de esos artículos.  

## ROBERTO:
HAY una manera de contabilizar los nombres específicos, no por grupo?

```{r chap16_10}
unique(index_O$Authors)
```

## Cuantos estudios unicos?

Para evaluar el largo de tiempo por estudio se necesita selecionar una combinación de variables unica

Subset

```{r chap16_11}
#names(index_O) Los nombres de las variables
SPECIES_O=index_O %>% select(StudyStart, StudyEnd, SpeciesAccepted, YearPublication, Authors, DOI_ISBN, OrganismType, MatrixPopulation, mat) %>% 
  group_by(SpeciesAccepted, YearPublication, OrganismType, StudyStart, StudyEnd) %>% 
  summarize(n_populations = length(unique(MatrixPopulation))) %>% 
  arrange(desc(n_populations)) %>% 
  mutate(StudyStart=as.numeric(StudyStart)) %>% 
  mutate(StudyEnd=as.numeric(StudyEnd)) %>% 
  drop_na(StudyStart, StudyEnd)

SPECIES_O %>% gt()


write_csv(SPECIES_O, "Species_O.csv")
```

# Number of populations per species study

```{r chap16_12}
as.data.frame(table(SPECIES_O$n_populations))


```

```{r chap16_13}

SPECIES_O$SpeciesAccepted <- fct_reorder(SPECIES_O$SpeciesAccepted, SPECIES_O$StudyStart, .desc = FALSE)

ggplot(SPECIES_O, aes(SpeciesAccepted, color=OrganismType))+
  geom_linerange(aes(x= SpeciesAccepted  , ymin=StudyStart, ymax=StudyEnd))+
  coord_flip()+
  theme(legend.position = c(0.2, 0.8))+
  ylab("")+
  xlab("")+
  rlt_theme+
  theme(axis.text.x = element_text(color = "grey20", size = 9, angle = 90, hjust = .5, vjust = .5, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 7, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size = 12, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 12, angle = 90, hjust = .5, vjust = .5, face = "plain"))


ggsave("Lenght_survey.png")

```

```{r chap16_14}

index_O=index_O %>% 
  mutate(StudyDuration=as.numeric(StudyDuration))

table(index_O$StudyDuration)
table(index_O$OrganismType)

ggplot(index_O, aes(StudyDuration, fill=OrganismType))+
         geom_histogram(colour="white")+
  facet_wrap(~OrganismType)+
  theme(legend.position = "none")+
  xlab("Study duration")+
  ylab("Frequency")+
  rlt_theme

#ggsave("Duración_Epi_Ter.pdf")

ggsave("Duración_Epi_Ter.png")
```

```{r chap16_15}
plot(index_O$Lon,index_O$Lat,main = "Location")
```

Getting the whole database for orchids

```{r chap16_16}

index <- which(compadre$metadata$Family=="Orchidaceae") 
names(Compadre)

subset(index_O, Family =="Orchidaceae"  &
             MatrixDimension >2)


subset(index_O,DicotMonoc == "Eudicot" & 
              Country %in% c("USA", "CAN") & 
              MatrixDimension > 2)

#cdb_compare(index_O,x)


x <- subset(index_O,Family == "Orchidaceae")

x_OT=x %>% 
  group_by(OrganismType)
```

```{r chap16_17}
#Orchids_New=as_cdb(index)
#compadre$mat[index]

Compadre_flagged <- cdb_flag(index_O)

x <- subset(Compadre_flagged, check_NA_A == FALSE & check_ergodic == TRUE)
x
y <- subset(Compadre_flagged, check_NA_A == FALSE & check_irreducible == TRUE)

y
xy <- subset(Compadre_flagged, check_NA_A == FALSE & check_irreducible == TRUE & check_ergodic == TRUE)
xy

lambdaVals <- sapply(matA(xy), popdemo::eigs, what="lambda")
summary(lambdaVals)
hist(lambdaVals, main = "Lambda values")
```

```{r chap16_18}

library(purrr)
lambdaVals1 <- map_dbl(matA(xy), ~popdemo::eigs(.x, what="lambda"))
 
 
#Or with popbio, which avoids some warning messages…
lambdaVals2 <- map_dbl(matA(xy), ~popbio::lambda(.x))
```

```{r chap16_19}
x2=xy %>% 
  mutate(OrganismType = case_when(
    Genus ==  "Caladenia" & OrganismType == "Epiphyte" ~ "Herbaceous perennial",
    TRUE ~ OrganismType
  ))

epi=x2 %>% 
  filter(OrganismType=="Epiphyte")

terr=x2 %>% 
  filter(OrganismType=="Herbaceous perennial")



```

Compadre_flagged \<- cdb_flag(index_O)

x \<- subset(Compadre_flagged, check_NA_A == FALSE & check_ergodic == TRUE)

lambdaVals \<- sapply(matA(x), popdemo::eigs, what="lambda") summary(lambdaVals) hist(lambdaVals, main = "Lambda values")

```{r chap16_20}

Compadre_flagged_epi <- cdb_flag(epi)

x_epi <- subset(Compadre_flagged_epi, check_NA_A == FALSE & check_ergodic == TRUE)

#sapply(matA(x_epi), popdemo::eigs, what="lambda")

library(purrr)
lambda_epi <- map_dbl(matA(x_epi), ~popdemo::eigs(.x, what="lambda"))

#Or with popbio, which avoids some warning messages…
lambda_terr <- map_dbl(matA(terr), ~popbio::lambda(.x))
```

```{r chap16_21}
summary(lambda_epi)
hist(lambda_epi, main = "Lambda values")

summary(lambda_terr)
hist(lambda_terr, main = "Lambda values")
```

```{r chap16_22}
df_Lamb_epi=as.data.frame(lambda_epi)
df_Lamb_epi=df_Lamb_epi %>% 
  add_column(Habit_Type = "Epiphyte") %>% 
  rename(lambda=lambda_epi)


df_Lamb_terr=as.data.frame(lambda_terr)
df_Lamb_terr=df_Lamb_terr %>% 
  add_column(Habit_Type = "Terrestrial")%>% 
  rename(lambda=lambda_terr)


ALL_Lambdas=rbind(df_Lamb_epi, df_Lamb_terr)
```

```{r chap16_23}
ggplot(ALL_Lambdas, aes(lambda, fill=Habit_Type ))+
  geom_histogram(colour="white") + 
  facet_wrap( ~Habit_Type)+
  rlt_theme

ggsave("Terr_Epi_lambda.png")
```

The number of populations

```{r chap16_24}
x2 %>% 
  group_by(SpeciesAccepted) %>% 
  summarize(n_populations = length(unique(MatrixPopulation))) %>% 
  arrange(desc(n_populations))
```

```{r chap16_25}

compadre_replicated_pops <- x2 %>% 
  group_by(SpeciesAccepted) %>% 
  mutate(n_pops = length(unique(MatrixPopulation))) %>% 
  ungroup() %>%
  subset(n_pops >= 10)

compadre_replicated_pops
```

```{r chap16_26}
ggplot2::ggplot(x2, aes(Lon, Lat)) +
  borders(database = "world", fill = "grey80", col = NA) +
  geom_point(col = "steelblue", size = 1.8, alpha = 0.8)

ggsave("orchid_map.jpg")
```

## Important to include only matrices that are annual.

Unless we data wrangle the life span so it represent a year worth instead of life span.

```{r chap16_27}
# function to calculate life expectancy
lifeExpectancy <- function(matU, startLife) {
  N <- solve(diag(nrow(matU)) - matU)
  return(colSums(N)[startLife])
}

compadre_life_expect <- x2 %>% 
  filter(ProjectionInterval >0.7) |> 
  filter(MatrixComposite == "Mean", # filter is the dplyr version of subset
         MatrixTreatment == "Unmanipulated",
         MatrixCaptivity == "W",
         #ProjectionInterval == "1"
         ) %>% 
  mutate(StageID = cdb_id_stages(.)) %>%
  cdb_collapse(columns = "StageID") %>%
  cdb_flag() %>% 
  filter(check_NA_U == FALSE,
         check_zero_U == FALSE,
         check_singular_U == FALSE) %>% 
  mutate(matU = matU(.), start_life = mpm_first_active(.)) %>% 
  mutate(life_expectancy = mapply(lifeExpectancy, matU, start_life)) %>% 
 # filter(life_expectancy >= 1) %>% 
  mutate(OrganismType = reorder(OrganismType, life_expectancy, median))



compadre_life_expect |> 
  group_by(OrganismType) |> 
  summarize(mean_LS= mean(life_expectancy, na.rm=TRUE),
            sd_LS = sd(life_expectancy, na.rm=TRUE))


ggplot2::ggplot(compadre_life_expect, aes(OrganismType, life_expectancy, colour=OrganismType)) +
  geom_boxplot() +geom_point()+
  scale_y_log10() +
  coord_flip() +
  labs(x = NULL, y = "Life expectancy (log(years))")+
  rlt_theme+
  theme(legend.position = "none")

ggsave("Life_Span.png")
```



```{r chap16_28}

#SPECIES_O$SpeciesAccepted <- fct_reorder(SPECIES_O$SpeciesAccepted, SPECIES_O$StudyStart, .desc = FALSE)

compadre_life_expect |> select(mat, Genus, SpeciesAccepted, life_expectancy) |> 
  group_by(SpeciesAccepted) |> 
  summarize(mean_LS= mean(life_expectancy, na.rm=TRUE),
            sd_LS = sd(life_expectancy, na.rm=TRUE))


ggplot(compadre_life_expect, aes(x=reorder(SpeciesAccepted, life_expectancy), life_expectancy, colour=OrganismType)) +
  geom_boxplot() +
  geom_point()+
  scale_y_log10() +
  coord_flip() +
  labs(x = NULL, y = "Life expectancy (log(years))")+
  rlt_theme+
  theme(legend.position = "none")

ggsave("Genus_Life_Span.png")
```




```{r chap16_29}

#SPECIES_O$SpeciesAccepted <- fct_reorder(SPECIES_O$SpeciesAccepted, SPECIES_O$StudyStart, .desc = FALSE)

compadre_life_expect |> 
  group_by(Genus) |> 
  summarize(mean_LS= mean(life_expectancy, na.rm=TRUE),
            sd_LS = sd(life_expectancy, na.rm=TRUE)) |> 
  filter(Genus %in% c("Caladenia"))

compadre_life_expect |> 
  filter(Genus %in% c("Caladenia")) |> 
ggplot( aes(x=reorder(SpeciesAccepted, life_expectancy), life_expectancy, colour=OrganismType)) +
  geom_boxplot() +
  geom_point()+
  #scale_y_log10() +
  coord_flip() +
  labs(x = NULL, y = "Life expectancy (years)")+
  rlt_theme+
  theme(legend.position = "none")

ggsave("Caladenia_Life_Span.png")
```

Test difference in life span.

```{r chap16_30}
unique(compadre_life_expect$OrganismType)

t.test(life_expectancy~OrganismType, data=compadre_life_expect)


shapiro.test(compadre_life_expect$life_expectancy) # Not normaly distributed


library(car)

leveneTest(life_expectancy~OrganismType, data=compadre_life_expect) # equal variance but not notmaly distributed

```

Use robust Approach

```{r chap16_31}
library(WRS2)
source("/Users/rlt/Library/CloudStorage/Dropbox/GitHub_Dropbox_Drive/GitHub/Diagnostico_Poblacional/Diagnostico_Poblacional/Rallfun-v38.txt", chdir = T) # Home computer
#source("/Users/rlt/Dropbox/METAS+COHORT_D/Rallfun-v38.txt", chdir = T)
#source("/Users/rlt/Dropbox/Ackermanstuff/Pollinator_Interaction/Specificity_Index_pollinators/Rallfun-v38.txt", chdir = T) ## Work laptop Computer
#source("/Users/raymondtremblay/Dropbox/METAS+COHORT_D/Rallfun-v38.txt", chdir = T) #When used on Monique
```

```{r chap16_32}
unique(compadre_life_expect$OrganismType)

Cf=cdb_flatten(compadre_life_expect)


YSEC_T=Cf %>% 
  dplyr::select("life_expectancy", "OrganismType") %>% 
  filter(OrganismType== "Herbaceous perennial")

YSEC_T
YSEC_E=Cf %>% 
  dplyr::select("life_expectancy", "OrganismType") %>% 
  filter(OrganismType== "Epiphyte")

yuenbt(YSEC_T$life_expectancy, YSEC_E$life_expectancy, alpha=.05, nboot=10000, side=T)

```

```{r chap16_33}
library(Rcompadre)
library(popdemo)
data(Compadre)


Compadre$matA <- matA(Compadre)

# create empty vector to store output
Compadre$dim <- numeric(nrow(Compadre))

index$dim <- numeric(nrow(index_O))

# loop through all rows of Compadre
for (i in seq_len(nrow(Compadre))) {
  Compadre$dim[i] <- nrow(Compadre$matA[[i]])
}

# function to determine whether matrix 'mat' has any stages with no transitions
NullStages <- function(mat) any(colSums(mat) == 0)

# apply function to every element of A
Compadre$null_stages <- sapply(Compadre$matA, NullStages)

NullStages(Compadre$matA[[1]]) # apply function to single element
Compadre$null_stages <- sapply(matA(Compadre), NullStages)
```
